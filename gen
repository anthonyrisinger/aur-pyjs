#!/bin/bash
# compile pyjamas AUR app into deployable JS application

exec 3> /dev/null

spushd () { pushd ${1} >&3; }
spopd () { popd >&3; }
fatal () { echo "${1}"; exit 1; }

BASE=$(dirname $(readlink -f ${0}))
: ${BASE_ALT:=${BASE}}
spushd ${BASE}

: ${PYJS_EXEC:=}
PYJS_EXEC_POSSIBLE=(
    "${PYJS_EXEC}"                      # env
    "${BASE}/.pyjs/bin/pyjsbuild"       # local
    "${BASE_ALT}/.pyjs/bin/pyjsbuild"   # parent
    "$(which pyjsbuild 2>&-)"           # system
)

# only if env doesn't exist
! [ -e "${PYJS_EXEC}" ] && {
    for x in ${PYJS_EXEC_POSSIBLE[@]}; do
        if [ -e "${x}" ]; then
            PYJS_EXEC=${x}
            break
        fi
    done
}

# last try
if ! [ -e "${PYJS_EXEC}" ]; then
    ./init 'true' || fatal 'could not find PYJS_EXEC (pyjsbuild)'
    PYJS_EXEC="${BASE}/.pyjs/bin/pyjsbuild"
fi

# don't remove the folder; SimpleHTTPServer could be running
rm -rf out/*

# build AUR
spushd src
${PYJS_EXEC} -mcO --bootstrap-file='Aur.js' --output='../out' Aur.py
spopd

# copy pub folder to out
cp -R pub/* out

spopd
exit 0
